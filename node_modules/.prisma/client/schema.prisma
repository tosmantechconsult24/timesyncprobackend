generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String             @id @default(cuid())
  email                   String             @unique
  password                String
  firstName               String
  lastName                String
  role                    String             @default("employee")
  permissions             String             @default("[]")
  isActive                Boolean            @default(true)
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  AuditLog                AuditLog[]
  Employee                Employee?
  LeaveRequest            LeaveRequest[]
  TimeEntry               TimeEntry[]
  DepartmentsCreated      Department[]       @relation("DepartmentCreatedBy")
  ShiftsCreated           Shift[]            @relation("ShiftCreatedBy")
  ShiftAssignmentsCreated ShiftAssignment[]  @relation("ShiftAssignmentAssignedBy")
  DeductionApprovals      PayrollDeduction[] @relation("DeductionApprovedBy")
  InfractionReports       Infraction[]       @relation("InfractionReportedBy")
  InfractionApprovals     Infraction[]       @relation("InfractionApprovedBy")
}

model Department {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  managerId   String?
  color       String?
  budget      Float?
  isActive    Boolean    @default(true)
  createdById String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  CreatedBy   User?      @relation("DepartmentCreatedBy", fields: [createdById], references: [id])
  employees   Employee[]
}

model Shift {
  id              String            @id @default(cuid())
  name            String
  description     String?
  startTime       String
  endTime         String
  breakDuration   Int               @default(60)
  graceMinutes    Int               @default(15)
  overtimeAfter   Float             @default(8)
  workingDays     String            @default("[1,2,3,4,5]")
  color           String?
  isNightShift    Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdById     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CreatedBy       User?             @relation("ShiftCreatedBy", fields: [createdById], references: [id])
  employees       Employee[]
  ShiftAssignment ShiftAssignment[]
}

model Employee {
  id                      String             @id @default(cuid())
  employeeId              String             @unique
  firstName               String
  lastName                String
  email                   String?
  phone                   String?
  photo                   String?
  departmentId            String?
  designation             String?
  managerId               String?
  joinDate                DateTime           @default(now())
  employmentType          String             @default("full_time")
  status                  String             @default("active")
  shiftId                 String?
  salary                  Float?
  hourlyRate              Float?
  cardNumber              String?
  faceEnrolled            Boolean            @default(false)
  fingerprintEnrolled     Boolean            @default(false)
  fingerprintTemplate     String? // USB fingerprint scanner template data
  fingerprintTemplateDate DateTime? // When the fingerprint was enrolled
  userId                  String?            @unique
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  AttendanceLog           AttendanceLog[]
  BiometricData           BiometricData[]
  department              Department?        @relation(fields: [departmentId], references: [id])
  Employee                Employee?          @relation("EmployeeToEmployee", fields: [managerId], references: [id])
  other_Employee          Employee[]         @relation("EmployeeToEmployee")
  shift                   Shift?             @relation(fields: [shiftId], references: [id])
  User                    User?              @relation(fields: [userId], references: [id])
  LeaveBalance            LeaveBalance[]
  LeaveRequest            LeaveRequest[]
  Notification            Notification[]
  ShiftAssignment         ShiftAssignment[]
  TimeEntry               TimeEntry[]
  EmployeeRate            EmployeeRate?
  EmployeeDeductions      PayrollDeduction[] @relation("EmployeeDeductions")
  EmployeeInfractions     Infraction[]       @relation("EmployeeInfractions")
}

model InactiveEmployee {
  id             String    @id @default(cuid())
  employeeId     String    @unique
  employeeName   String
  departmentId   String?
  inactiveReason String // suspended, resigned, sacked, retired
  details        String? // Additional details about the reason
  suspendedBy    String? // User ID who suspended
  suspendedAt    DateTime  @default(now())
  reactivatedAt  DateTime?
  reactivatedBy  String? // User ID who reactivated
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  User       User?    @relation(fields: [userId], references: [id])
}

model AttendanceLog {
  id           String    @id
  employeeId   String
  eventType    String
  timestamp    DateTime
  terminalId   String?
  verifyMethod String?
  snapshot     String?
  temperature  Float?
  maskDetected Boolean?
  processed    Boolean   @default(false)
  rawData      String?
  createdAt    DateTime  @default(now())
  Employee     Employee  @relation(fields: [employeeId], references: [id])
  Terminal     Terminal? @relation(fields: [terminalId], references: [id])
}

model BiometricData {
  id         String   @id
  employeeId String
  type       String
  data       String?
  fingerNo   Int?
  enrolledAt DateTime @default(now())
  Employee   Employee @relation(fields: [employeeId], references: [id])
}

model LeaveBalance {
  id            String   @id
  employeeId    String
  leaveType     String
  year          Int
  totalDays     Int
  usedDays      Int      @default(0)
  remainingDays Int
  Employee      Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, leaveType, year])
}

model LeaveRequest {
  id              String    @id
  employeeId      String
  leaveType       String
  startDate       DateTime
  endDate         DateTime
  totalDays       Int
  reason          String?
  status          String    @default("pending")
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User?     @relation(fields: [approvedById], references: [id])
  Employee        Employee  @relation(fields: [employeeId], references: [id])
}

model Notification {
  id         String    @id
  userId     String?
  employeeId String?
  type       String
  title      String
  message    String
  isRead     Boolean   @default(false)
  data       String?
  createdAt  DateTime  @default(now())
  Employee   Employee? @relation(fields: [employeeId], references: [id])
}

model Setting {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model ShiftAssignment {
  id           String    @id
  employeeId   String
  shiftId      String
  startDate    DateTime
  endDate      DateTime?
  isActive     Boolean   @default(true)
  assignedById String?
  createdAt    DateTime  @default(now())
  Employee     Employee  @relation(fields: [employeeId], references: [id])
  Shift        Shift     @relation(fields: [shiftId], references: [id])
  AssignedBy   User?     @relation("ShiftAssignmentAssignedBy", fields: [assignedById], references: [id])
}

model Terminal {
  id              String          @id
  name            String
  ipAddress       String
  port            Int             @default(80)
  username        String          @default("admin")
  password        String
  deviceType      String?
  serialNumber    String?
  firmwareVersion String?
  location        String?
  isOnline        Boolean         @default(false)
  lastSyncAt      DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  AttendanceLog   AttendanceLog[]
  TimeEntry       TimeEntry[]
}

model TimeEntry {
  id            String    @id
  employeeId    String
  clockIn       DateTime
  clockOut      DateTime?
  breakStart    DateTime?
  breakEnd      DateTime?
  totalHours    Float?
  regularHours  Float?
  overtimeHours Float?
  breakMinutes  Int?
  status        String    @default("clocked_in")
  location      String?
  terminalId    String?
  verifyMethod  String?
  clockInPhoto  String?
  clockOutPhoto String?
  notes         String?
  isManualEntry Boolean   @default(false)
  approvedById  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  User          User?     @relation(fields: [approvedById], references: [id])
  Employee      Employee  @relation(fields: [employeeId], references: [id])
  Terminal      Terminal? @relation(fields: [terminalId], references: [id])
}

model EmployeeRate {
  id            String    @id @default(cuid())
  employeeId    String    @unique
  hourlyRate    Float // Hourly rate in NGN
  dailyRate     Float? // Daily rate (optional)
  salary        Float? // Monthly salary (optional)
  overtimeRate  Float? // Overtime hourly rate (default: hourlyRate * 1.5)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  currency      String    @default("NGN")
  rateType      String    @default("hourly") // hourly, daily, monthly
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([effectiveFrom])
}

model PayrollDeduction {
  id            String    @id @default(cuid())
  employeeId    String
  deductionType String // infraction, loan, tax, insurance, etc.
  amount        Float // Amount in NGN
  reason        String? // Reason for deduction
  description   String? // Detailed description
  month         DateTime // Month for which deduction applies
  status        String    @default("pending") // pending, approved, rejected, applied
  approvedBy    String? // Super admin who approved
  approvedAt    DateTime?
  appliedAt     DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Employee      Employee  @relation("EmployeeDeductions", fields: [employeeId], references: [id], onDelete: Cascade)
  ApprovedBy    User?     @relation("DeductionApprovedBy", fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([month])
  @@index([status])
}

model Infraction {
  id          String    @id @default(cuid())
  employeeId  String
  type        String // late_arrival, absent, misconduct, etc.
  severity    String    @default("minor") // minor, major, critical
  amount      Float? // Deduction amount in NGN (if applicable)
  description String
  date        DateTime
  reportedBy  String? // Manager or admin who reported
  status      String    @default("pending") // pending, approved, rejected
  approvedBy  String? // Super admin who approved
  approvedAt  DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Employee    Employee  @relation("EmployeeInfractions", fields: [employeeId], references: [id], onDelete: Cascade)
  ReportedBy  User?     @relation("InfractionReportedBy", fields: [reportedBy], references: [id])
  ApprovedBy  User?     @relation("InfractionApprovedBy", fields: [approvedBy], references: [id])

  @@index([employeeId])
  @@index([date])
  @@index([status])
}
